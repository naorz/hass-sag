## ğŸ“‹ Prerequisites

* A registered domain on **Cloudflare**.
* **Home Assistant** running (Docker or OS).
* An active **Cloudflare Tunnel** (cloudflared) connecting your instance to the web.
* **Node.js** installed on your local machine (to run the script).

---

## ğŸ›  Option 1: The Automated Way (Recommended)

Run the script directly from the repository. It will handle the folder structure, key generation, and clipboard management for you.

```bash
npx zx https://raw.githubusercontent.com/naorz/hass-sag/main/generator.ts
```

### The Workflow:

1. **Select Full Setup**: This handles everything from mTLS to the Portal.
2. **Configuration**: Provide your domain (e.g., `example.com`) and subdomains.
3. **mTLS Phase**:
* The script generates a CSR and copies it to your clipboard.
* Navigate to **Cloudflare Zero Trust > Security > Certificates > Client Certificates**.
* Click **Create Certificate**, choose **Use my own CSR**, and paste.
* Save the resulting certificate as `client.pem` in the `tunnel_cert` folder created by the script.


4. **Apple Profile**: The script packages your certs into a `.mobileconfig` file automatically.
5. **Portal**: A Docker Compose folder is generated. Run `docker compose up -d` to host your certificates on a secure download page.

---

## ğŸ“– Option 2: The Manual Deep Dive

If you prefer to understand every moving part, follow these manual steps.

### Step 1: Generate Client Identity

Run these commands to create your unique device identity:

```bash
# 1. Generate Private Key
openssl genrsa -out client.key 2048

# 2. Generate Certificate Signing Request (CSR)
openssl req -new -key client.key -out client.csr -subj "/CN=ha.yourdomain.com"

```

Upload `client.csr` to Cloudflare and save the issued certificate as `client.pem`.

### Step 2: Create the Apple Bundle

iOS requires a `.p12` format to install certificates.

```bash
# Combine Key and Pem into P12
openssl pkcs12 -export -out device-cert.p12 -inkey client.key -in client.pem

```

### Step 3: Configure Cloudflare Zero Trust

1. **Upload Root CA**: Go to **Certificates** and ensure the Cloudflare Managed CA is active.
2. **Create Access Application**:
* Go to **Access > Applications**.
* Select your Home Assistant domain.


3. **Add mTLS Policy**:
* Create a policy named "Enforce mTLS".
* **Action**: Service Auth.
* **Include**: Selector "Valid Client Certificate".



---

## ğŸ“² Installing on Your Devices

### iPhone / iPad

1. **Transfer**: Send the `.mobileconfig` (generated by the script) to your iPhone via AirDrop or the Secure Portal.
2. **Install**: Go to **Settings > Profile Downloaded > Install**.
3. **Trust**: Go to **Settings > General > About > Certificate Trust Settings** and toggle on full trust for the root certificate.

### MacOS

1. Double-click the `.mobileconfig`.
2. Open **System Settings > Privacy & Security > Profiles** and click Install.

---

## ğŸ”’ Verification

Once installed, try accessing your Home Assistant URL from a device **without** the certificate. You should see a `403 Forbidden` or a Cloudflare block page. Only devices with the installed identity can now even "see" your login screen.

---

## ğŸ™ GitHub Onboarding (Bonus)

If you are setting up a new developer machine, use **Mode 5** of the script.

1. It generates a passphrase-less key at `~/.ssh/github-key`.
2. It copies the public key for you to paste at [github.com/settings/keys](https://github.com/settings/keys).
3. It adds the key to your macOS keychain so you never have to type a password for `git push`.
